-----------------------------------------------------------------------------
-- Midcraft Commander
-- Author: MewK
-- Version: 0.2
--
-- This program is released under the MIT License (MIT).
-----------------------------------------------------------------------------

local args = { ... }
if # args == 1 and (args[1] == '-h' or args[1] == '?') then
	print('Midcraft Commander 0.2')
	print('')
	print('Keys:')
	print('  Ctrl   Activates the menu') 
	print('  Tab    Activates the integrated shell')
	print('  Space  Selects/deselects an entry')
	return
end

-- TODO:
-- shortcuts
-- config file
-- - editor path
-- - folder default action (run, edit, help)

shell.run('drawing.lua')
shell.run('filesystem.lua')

-- General vars
local running = true
local keyFunctions = {}

-- Terminal vars
local w, h = term.getSize()
local hw = math.floor(w / 2)

-- View vars
local views = {}
local _activeView = 1;

-- Menu vars
local menuActive = false
local menuFunctions = {}
local menuItemSelection = 0
local subMenuItemSelection = 0

-- Shell vars
local commandHistory = {}

-- Clipboard vars
local clipboard = {}
local clipboardAction = 0 -- 0 = none, 1 = copy, 2 = cut

-- Init views

local shellPath = buildPath(shell.dir(), nil)
views = {
	{
		x = 1, 
		y = 2, 
		width = hw - 1, 
		height = h - 3, 
		active = true, 
		scrollOffset = 0, 
		selectionIndex = 1, 
		currentDirectory = shellPath, 
		entryList = listEntries(shellPath)
	},
	{
		x = hw + 2, 
		y = 2, 
		width = hw - 1, 
		height = h - 3, 
		active = false, 
		scrollOffset = 0, 
		selectionIndex = 1, 
		currentDirectory = shellPath, 
		entryList = listEntries(shellPath)
	}
}

-- Functions

local function activeView() 
	return views[_activeView] 
end

local function activeMenu() 
	return menuFunctions[menuItemSelection] 
end

local function readUserLine(prefix, commandHistory)
	term.setCursorPos(1, h)
	term.clearLine()
	term.write(prefix)

	local line = read(nil, commandHistory)
	return line
end

local function refreshEntries()
	for n, view in ipairs(views) do
		view.entryList = listEntries(view.currentDirectory)
	end
end

local function clearClipBoard() 
	clipboard = {}
	clipboardAction = 0
end

local function drawScreen()
	term.clear()
	
	-- Draw frame
    drawLabeledLineH(1, 1, hw, views[1].currentDirectory)
	drawLabeledLineH(hw + 2, 1, hw, views[2].currentDirectory)
	
	drawLineV(hw + 1, 1, h - 1)
	drawLineV(hw, 1, h - 1)
	
	-- Draw dir lists
	for index, view in ipairs(views) do
		drawEntries(view, clipboard, clipboardAction, buildPath)
	end
	
	-- Draw scroll indicators
	
	-- Left top
	if views[1].scrollOffset > 0 then
		term.setCursorPos(hw, 2)
		term.write('#')
	end
	
	-- Left bottom
	if # views[1].entryList - views[1].scrollOffset > views[1].height then
		term.setCursorPos(hw, h - 2)
		term.write('#')
	end
	
	-- Right top
	if views[2].scrollOffset > 0 then
		term.setCursorPos(hw + 1, 2)
		term.write('#')
	end
	
	-- Right bottom
	if # views[2].entryList - views[2].scrollOffset > views[2].height then
		term.setCursorPos(hw + 1, h - 2)
		term.write('#')
	end
		
	-- Draw menu (drawn last to overwrite views if necesary)
	drawMenu(1, h, menuFunctions, menuItemSelection, subMenuItemSelection)
end

-- Menu

menuFunctions = {
	-- File sub-menu
	{
		name = 'File',
		children = {
			-- Run with parameters command
			{ 
				name = 'Run',
				action = function(path)
					local parameter = readUserLine('Parameters: ', nil)
					parseCommand(path..' '..parameter)
				end
			},
			
			-- Edit command
			{ 
				name = 'Edit',
				action = function(path)
					if not fs.isDir(path) then
						runProgram('edit', path)
					end
				end
			},
			
			-- Copy command
			{ 
				name = 'Copy',
				action = function(path)
					if clipboardAction == 1 then
						clipboardAction = 0
					else
						clipboardAction = 1
					end
				end
			},
			
			-- Cut command
			{ 
				name = 'Cut',
				action = function(path)
					if clipboardAction == 2 then
						clipboardAction = 0
					else
						clipboardAction = 2
					end
				end
			},
			
			-- Paste command
			{ 
				name = 'Paste',
				action = function(path)
					if clipboardAction > 0 then			
						for index, value in ipairs(clipboard) do
							local targetPath = buildPath(activeView().currentDirectory, fs.getName(value))
							-- Copy
							if clipboardAction == 1 then
								moveEntry(value, targetPath, true, false)
							
							-- Move
							elseif clipboardAction  == 2 then
								moveEntry(value, targetPath, false, false)
							end
						end
						
						clearClipBoard()
						refreshEntries()
					end
				end
			},
			
			-- Delete command
			{ 
				name = 'Delete',
				action = function(path)
					for index, value in ipairs(clipboard) do
						fs.delete(value)
						if value == path then
							activeView().selectionIndex = activeView().selectionIndex - 1
							if (activeView().selectionIndex < 1) then
								activeView().selectionIndex = 1
							end
						end
					end
					
					clearClipBoard()
					refreshEntries()
				end
			},
			
			-- New File command
			{ 
				name = 'Rename',
				action = function(path)
					local name = readUserLine('New Name: ', nil)
					if name ~= '' then
						moveEntry(path, buildPath(activeView().currentDirectory, name), false, true)
						refreshEntries()
					end
				end
			}
		}
	},
	
	-- System sub-menu
	{
		name = 'System',
		children = {
			-- New File command
			{ 
				name = 'New file',
				action = function(path)
					local name = readUserLine('Name: ', nil)
					if name ~= '' then
						path = buildPath(activeView().currentDirectory, name)
						local file = io.open(path, 'w')
						file:write('')
						file:close()
						refreshEntries()
					end
				end
			},
			
			-- New folder command
			{ 
				name = 'New folder',
				action = function(path)
					local name = readUserLine('Name: ', nil)
					if name ~= '' then
						path = buildPath(activeView().currentDirectory, name)
						fs.makeDir(path)
						refreshEntries()
					end
				end
			}
		}
	},
	
	-- Exit command
	{ 
		name = 'Exit',
		action = function(path)
			running = false
		end
	}
}

-- Keys

keyFunctions = {
	-- Up
	{ 
		code = 200,
		action = function()
			-- Move entry selection
			if not menuActive then
				if activeView().selectionIndex > 1 then
					activeView().selectionIndex = activeView().selectionIndex - 1
					if activeView().selectionIndex <= activeView().scrollOffset then
						activeView().scrollOffset = activeView().scrollOffset - activeView().height
					end
				end
			else
				local _activeMenu = activeMenu()
				if _activeMenu and _activeMenu.children then
					subMenuItemSelection = subMenuItemSelection - 1
					if subMenuItemSelection < 1 then
						subMenuItemSelection = # _activeMenu.children
					end
				end
			end
		end
	},
	
	-- Down
	{ 
		code = 208,
		action = function()
			-- Move entry selection
			if not menuActive then
				if activeView().selectionIndex < # activeView().entryList then
					activeView().selectionIndex = activeView().selectionIndex + 1
					if activeView().selectionIndex > activeView().height + activeView().scrollOffset then
						activeView().scrollOffset = activeView().scrollOffset + activeView().height
					end
				end
			else
				local _activeMenu = activeMenu()
				if _activeMenu and _activeMenu.children then
					subMenuItemSelection = subMenuItemSelection + 1
					if subMenuItemSelection > # _activeMenu.children then
						subMenuItemSelection = 1
					end
				end
			end
		end
	},
	
	-- Left
	{ 
		code = 203,
		action = function()
			-- Change active view
			if not menuActive then
				activeView().active = false
				_activeView = _activeView - 1
				if _activeView < 1 then
					_activeView = # views
				end
				activeView().active = true
				
			-- Move menu selection
			else
				menuItemSelection = menuItemSelection - 1
				if menuItemSelection < 1 then
					menuItemSelection = # menuFunctions
				end
				subMenuItemSelection = 1
			end
		end
	},
	
	-- Right
	{ 
		code = 205,
		action = function()
			-- Change active side
			if not menuActive then
				activeView().active = false
				_activeView = _activeView + 1
				if _activeView > # views then
					_activeView = 1
				end
				activeView().active = true
				
			-- Move menu selection
			else
				menuItemSelection = menuItemSelection + 1
				if menuItemSelection > # menuFunctions then
					menuItemSelection = 1
				end
				subMenuItemSelection = 1
			end
		end
	},
	
	-- Enter
	{ 
		code = 28,
		action = function()
			local targetPath = buildPath(activeView().currentDirectory, activeView().entryList[activeView().selectionIndex])
			-- Run
			if not menuActive then
				local newEntryList = nil
				
				if fs.exists(targetPath) then
					if fs.isDir(targetPath) then
						newEntryList = listEntries(targetPath)
						activeView().currentDirectory = targetPath
						activeView().selectionIndex = 1
						activeView().entryList = newEntryList
					else
						runProgram(targetPath)
						refreshEntries()
					end
				end
				
			-- Menu selection
			else
				local menuItem = menuFunctions[menuItemSelection]
				if menuItem then
					if menuItem.action then
						menuItem.action(targetPath)
					elseif menuItem.children then
						local subMenuItem = menuItem.children[subMenuItemSelection]
						if subMenuItem and subMenuItem.action then
							subMenuItem.action(targetPath)
						end
					end
				end
				
				menuActive = false
				menuItemSelection = 0
				subMenuItemSelection = 0
			end
		end
	},
	
	-- Ctrl (menu toggle)
	{ 
		code = 29,
		action = function()
			menuActive = not menuActive
			if menuActive then
				menuItemSelection = 1
				subMenuItemSelection = 1
			else
				menuItemSelection = 0
				subMenuItemSelection = 0
			end
		end
	},
	
	-- Tab (command line toggle)
	{ 
		code = 15,
		action = function()
			local command
			repeat
				command = readUserLine(shell.dir()..'> ', commandHistory)
				if command ~= '' then
					if command ~= commandHistory[# commandHistory] then
						table.insert(commandHistory, command)
					end
					parseCommand(command)
					refreshViews()
				end
			until command == ''
		end
	},
	
	-- Space (selection toggle)
	{ 
		code = 57,
		action = function()
			if not menuActive then
				local entry = activeView().entryList[activeView().selectionIndex]
				local targetPath = buildPath(activeView().currentDirectory, entry)
				
				if entry == '/..' then
					return
				end
				
				local entryIndex = 0
				for index, value in ipairs(clipboard) do
					if value == targetPath then
						entryIndex = index
						break
					end
				end
				
				if entryIndex > 0 then
					table.remove(clipboard, entryIndex)
					if # clipboard == 0 then
						clipboardAction = 0
					end
				else
					table.insert(clipboard, targetPath)
				end
			end
		end
	}
}

-- Body

drawScreen()

while running do
	local event, param = os.pullEvent('key')
	for index, keyFunction in ipairs(keyFunctions) do
		if keyFunction.code == param then
			keyFunction.action()
			drawScreen()
		end
	end
end

term.clear()
term.setCursorPos(1, 1)